<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Trouver son bureau de vote ‚Äì Ville de Montivilliers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --couleur-action: #e61b5c;
  --couleur-action-hover: #c91650;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #f4f6f8;
}

#bloc {
  max-width: 1000px;
  margin: 0 auto;
  padding: 1.2rem;
  background: #fff;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,.1);
}

#contenu {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.2rem;
}

@media (min-width: 900px) {
  #contenu {
    grid-template-columns: 1fr 1.2fr;
  }
}

label {
  font-weight: bold;
}

input {
  width: 100%;
  padding: .6rem;
  margin-top: .4rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

button {
  width: 100%;
  margin-top: .8rem;
  padding: .7rem;
  font-weight: bold;
  background: var(--couleur-action);
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background: var(--couleur-action-hover);
}

#resultat {
  margin-top: 1rem;
  padding: .8rem;
  border-radius: 4px;
}

#resultat.succes {
  background: #e8f3ee;
  border-left: 4px solid #2e8b57;
}

#resultat.erreur {
  background: #fbeaea;
  border-left: 4px solid #b00020;
}

#map {
  height: 380px;
  border-radius: 6px;
  display: none;
}

.mention {
  margin-top: 1.2rem;
  font-size: .85rem;
  color: #555;
}
</style>
</head>

<body>

<div id="bloc">

  <div id="contenu">
    <div>
      <label for="adresse">Entrez votre adresse :</label>
      <input id="adresse" placeholder="Ex : 12 avenue Charles de Gaulle">
      <button onclick="chercher()">Rechercher</button>
      <div id="resultat"></div>
    </div>

    <div id="map"></div>
  </div>

  <div class="mention">
    Les informations relatives √† votre bureau de vote figurent √©galement sur votre carte √©lectorale.
    En cas de doute, vous pouvez v√©rifier votre situation √©lectorale sur le site
    <strong>Service-public.fr</strong>.<br>
    <em>La carte est fournie √† titre illustratif.</em>
  </div>

</div>

<script>
let DATA, RUES = {};
let map, markerBureau;

const LIMITES_MONTIVILLIERS = [
  [49.550, 0.160],
  [49.575, 0.205]
];

// üîÅ DICTIONNAIRE D‚ÄôALIAS (abr√©viations ‚Üí forme longue)
const ALIAS = {
  "pt": "president",
  "pres": "president",
  "f": "francois",
  "ste": "sainte",
  "st": "saint",
  "comman": "commandant",
  "cmdt": "commandant"
};

// üß† NORMALISATION ENRICHIE
function normaliser(texte) {
  let t = texte.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9 ]/g, " ");

  // remplacement des alias mot par mot
  t = t.split(" ").map(mot => ALIAS[mot] || mot).join(" ");

  return t
    .replace(/\b(de|du|des|la|le|l|d)\b/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

fetch("data-bureaux.json")
  .then(r => r.json())
  .then(d => {
    DATA = d;

    Object.entries(d.rues_simples).forEach(([rue, bureau]) => {
      RUES[normaliser(rue)] = { type: "simple", bureau };
    });

    Object.entries(d.rues_a_cheval).forEach(([rue, regles]) => {
      RUES[normaliser(rue)] = { type: "complexe", regles };
    });
  });

async function chercher() {
  const res = document.getElementById("resultat");
  const mapDiv = document.getElementById("map");
  res.className = "";
  res.textContent = "Recherche en cours‚Ä¶";
  mapDiv.style.display = "none";

  const saisie = document.getElementById("adresse").value;
  const r = await fetch("https://api-adresse.data.gouv.fr/search/?q=" + encodeURIComponent(saisie) + "&limit=1");
  const d = await r.json();

  if (!d.features.length) {
    res.className = "erreur";
    res.textContent = "Adresse non reconnue.";
    return;
  }

  const props = d.features[0].properties;
  const rueNorm = normaliser(props.street || "");
  const numero = parseInt(props.housenumber, 10);

  const entree = RUES[rueNorm];
  if (!entree) {
    res.className = "erreur";
    res.textContent = "Adresse √† v√©rifier aupr√®s du service √©lections.";
    return;
  }

  let bureauNum;

  if (entree.type === "simple") {
    bureauNum = entree.bureau;
  } else {
    for (const r of entree.regles.regles) {
      if (numero >= r.min && numero <= r.max) {
        bureauNum = r.bureau ?? ((numero % 2 === 0) ? r.pairs : r.impairs);
      }
    }
  }

  const bureau = DATA.bureaux.find(b => b.numero === bureauNum);

  res.className = "succes";
  res.innerHTML = `‚úÖ <strong>Bureau ${bureau.numero} ‚Äì ${bureau.nom}</strong><br>üìç ${bureau.adresse}`;

  const rb = await fetch(
    "https://api-adresse.data.gouv.fr/search/?q=" +
    encodeURIComponent(bureau.adresse + ", Montivilliers") +
    "&limit=1"
  );
  const db = await rb.json();
  if (!db.features.length) return;

  const [lon, lat] = db.features[0].geometry.coordinates;

  if (!map) {
    map = L.map("map", {
      maxBounds: LIMITES_MONTIVILLIERS,
      maxBoundsViscosity: 1
    });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }

  if (markerBureau) markerBureau.remove();

  markerBureau = L.marker([lat, lon]).addTo(map);
  map.setView([lat, lon], 15);
  map.setMinZoom(map.getZoom());

  mapDiv.style.display = "block";
}
</script>

</body>
</html>
