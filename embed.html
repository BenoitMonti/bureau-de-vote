<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Trouver son bureau de vote ‚Äì Ville de Montivilliers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --couleur-action: #e61b5c;
  --couleur-action-hover: #c91650;
  --couleur-fond: #f4f6f8;
  --couleur-texte: #1a1a1a;
  --couleur-succes: #2e8b57;
  --couleur-erreur: #b00020;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: var(--couleur-fond);
  color: var(--couleur-texte);
}

#bloc {
  max-width: 520px;
  margin: 0 auto;
  padding: 1.2rem;
  background: #ffffff;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

label {
  font-weight: bold;
}

input {
  width: 100%;
  padding: 0.6rem;
  margin-top: 0.4rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
}

input:focus {
  outline: none;
  border-color: var(--couleur-action);
}

button {
  width: 100%;
  margin-top: 0.8rem;
  padding: 0.7rem;
  font-size: 1rem;
  font-weight: bold;
  background: var(--couleur-action);
  color: #ffffff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background: var(--couleur-action-hover);
}

#resultat {
  margin-top: 1rem;
  padding: 0.8rem;
  border-radius: 0px;
}

#resultat.succes {
  background: #e8f3ee;
  border-left: 4px solid var(--couleur-succes);
}

#resultat.erreur {
  background: #fbeaea;
  border-left: 4px solid var(--couleur-erreur);
}

.mention {
  margin-top: 1rem;
  font-size: 0.85rem;
  color: #555;
}
</style>
</head>

<body>

<div id="bloc">
  <label for="adresse">Entrez votre adresse :</label>
  <input id="adresse" placeholder="Ex : 12 avenue Charles de Gaule, Montivilliers">
  <button onclick="chercher()">Rechercher</button>

  <div id="resultat"></div>

  <div class="mention">
    Les informations relatives √† votre bureau de vote figurent √©galement sur votre carte √©lectorale.
    En cas de doute, vous pouvez v√©rifier votre situation √©lectorale sur le site
    <a href="https://www.service-public.fr/particuliers/vosdroits/services-en-ligne-et-formulaires/ISE"><strong>Service-public.fr</strong>.</a>
  </div>
</div>

<script>
let DATA;
let RUES = {};

function normaliser(t) {
  return t.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/\b(de|du|des|la|le|l')\b/g, "")
    .replace(/[^a-z0-9 ]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function levenshtein(a, b) {
  const m = Array.from({ length: b.length + 1 }, (_, i) => [i]);
  for (let j = 0; j <= a.length; j++) m[0][j] = j;
  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      m[i][j] = b[i-1] === a[j-1]
        ? m[i-1][j-1]
        : Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
    }
  }
  return m[b.length][a.length];
}

function trouverRueApprochante(r) {
  let best = null, dist = Infinity;
  for (const k in RUES) {
    const d = levenshtein(r, k);
    if (d < dist) { dist = d; best = k; }
  }
  return dist <= 2 ? best : null;
}

fetch("data-bureaux.json")
  .then(r => r.json())
  .then(d => {
    DATA = d;
    Object.entries(d.rues_simples).forEach(([rue, bureau]) => {
      RUES[normaliser(rue)] = { type: "simple", bureau };
    });
    Object.entries(d.rues_a_cheval).forEach(([rue, regles]) => {
      RUES[normaliser(rue)] = { type: "complexe", regles };
    });
  });

async function chercher() {
  const res = document.getElementById("resultat");
  res.className = "";
  res.textContent = "Recherche en cours‚Ä¶";

  const saisie = document.getElementById("adresse").value;
  const r = await fetch("https://api-adresse.data.gouv.fr/search/?q=" + encodeURIComponent(saisie) + "&limit=1");
  const d = await r.json();

  if (!d.features.length) {
    res.className = "erreur";
    res.textContent = "Adresse non reconnue.";
    return;
  }

  const props = d.features[0].properties;
  const rueNorm = normaliser(props.street || "");
  const numero = parseInt(props.housenumber, 10);

  let entree = RUES[rueNorm];
  if (!entree) {
    const approx = trouverRueApprochante(rueNorm);
    if (approx) entree = RUES[approx];
  }

  if (!entree) {
    res.className = "erreur";
    res.textContent = "Adresse √† v√©rifier aupr√®s du service √©lections.";
    return;
  }

  let bureauNum;

  if (entree.type === "simple") {
    bureauNum = entree.bureau;
  } else {
    const r = entree.regles;
    if (r.type === "pairs_impairs") {
      bureauNum = (numero % 2 === 0) ? r.pairs : r.impairs;
    } else {
      for (const regle of r.regles) {
        if (numero >= regle.min && numero <= regle.max) {
          bureauNum = regle.bureau ?? ((numero % 2 === 0) ? regle.pairs : regle.impairs);
        }
      }
    }
  }

  const bureau = DATA.bureaux.find(b => b.numero === bureauNum);
  res.className = "succes";
  res.innerHTML = `‚úÖ <strong>Bureau ${bureau.numero} ‚Äì ${bureau.nom}</strong><br>üìç ${bureau.adresse}`;
}
</script>

</body>
</html>
