<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Trouver son bureau de vote â€“ Ville de Montivilliers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --couleur-action: #e61b5c;
  --couleur-action-hover: #c91650;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #f4f6f8;
}

#bloc {
  max-width: 1000px;
  margin: 0 auto;
  padding: 1.2rem;
  background: #ffffff;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

#contenu {
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
}

label {
  font-weight: bold;
}

input {
  width: 100%;
  padding: 0.6rem;
  margin-top: 0.4rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

button {
  width: 100%;
  margin-top: 0.8rem;
  padding: 0.7rem;
  font-size: 1rem;
  font-weight: bold;
  background: var(--couleur-action);
  color: #ffffff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background: var(--couleur-action-hover);
}

#resultat {
  margin-top: 1rem;
  padding: 0.8rem;
  border-radius: 4px;
}

#resultat.succes {
  background: #e8f3ee;
  border-left: 4px solid #2e8b57;
}

#resultat.erreur {
  background: #fbeaea;
  border-left: 4px solid #b00020;
}

#map {
  height: 420px;
  border-radius: 6px;
  display: none;
}

.mention {
  margin-top: 1.2rem;
  font-size: 0.85rem;
  color: #555;
}
</style>
</head>

<body>

<div id="bloc">

  <div id="contenu">

    <!-- CARTE AU-DESSUS -->
    <div id="map"></div>

    <!-- FORMULAIRE -->
    <div>
      <label for="adresse">Entrez votre adresse :</label>
      <input id="adresse" placeholder="Ex : 12 avenue Charles de Gaulle, Montivilliers">
      <button onclick="chercher()">Rechercher</button>
      <div id="resultat"></div>
    </div>

  </div>

  <div class="mention">
    Les informations relatives Ã  votre bureau de vote figurent Ã©galement sur votre carte Ã©lectorale.
    En cas de doute, vous pouvez vÃ©rifier votre situation Ã©lectorale sur le site
    <strong>Service-public.fr</strong>.<br>
    <em>La carte est fournie Ã  titre illustratif.</em>
  </div>

</div>

<script>
let DATA, RUES = {};
let map, markerBureau;

// Limites gÃ©ographiques de Montivilliers
const LIMITES_MONTIVILLIERS = [
  [49.550, 0.160],
  [49.575, 0.205]
];

// IcÃ´ne URNE
const iconeUrne = L.icon({
  iconUrl: "data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24'>\
<rect x='3' y='9' width='18' height='12' rx='2' fill='%23e61b5c'/>\
<rect x='8' y='3' width='8' height='4' rx='1' fill='%231a1a1a'/>\
<rect x='10.5' y='1' width='3' height='6' fill='%23ffffff'/>\
</svg>",
  iconSize: [40, 40],
  iconAnchor: [20, 40],
  popupAnchor: [0, -36]
});

// Alias pour abrÃ©viations
const ALIAS = {
  "pt": "president",
  "pres": "president",
  "f": "francois",
  "st": "saint",
  "ste": "sainte",
  "comman": "commandant",
  "cmdt": "commandant"
};

// Normalisation enrichie
function normaliser(t) {
  let s = t.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9 ]/g, " ");

  s = s.split(" ").map(m => ALIAS[m] || m).join(" ");

  return s
    .replace(/\b(de|du|des|la|le|l|d)\b/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

// Chargement des donnÃ©es
fetch("data-bureaux.json")
  .then(r => r.json())
  .then(d => {
    DATA = d;

    Object.entries(d.rues_simples).forEach(([rue, bureau]) => {
      RUES[normaliser(rue)] = { type: "simple", bureau };
    });

    Object.entries(d.rues_a_cheval).forEach(([rue, regles]) => {
      RUES[normaliser(rue)] = { type: "complexe", regles };
    });
  });

async function chercher() {
  const res = document.getElementById("resultat");
  const mapDiv = document.getElementById("map");

  res.className = "";
  res.textContent = "Recherche en coursâ€¦";
  mapDiv.style.display = "none";

  const saisie = document.getElementById("adresse").value;

  const r = await fetch(
    "https://api-adresse.data.gouv.fr/search/?q=" +
    encodeURIComponent(saisie) + "&limit=1"
  );
  const d = await r.json();

  if (!d.features.length) {
    res.className = "erreur";
    res.textContent = "Adresse non reconnue.";
    return;
  }

  const props = d.features[0].properties;
  const rueNorm = normaliser(props.street || "");
  const numero = parseInt(props.housenumber, 10);

  const entree = RUES[rueNorm];
  if (!entree) {
    res.className = "erreur";
    res.textContent = "Adresse Ã  vÃ©rifier auprÃ¨s du service Ã©lections.";
    return;
  }

  let bureauNum;

  if (entree.type === "simple") {
    bureauNum = entree.bureau;
  } else {
    for (const r of entree.regles.regles) {
      if (numero >= r.min && numero <= r.max) {
        bureauNum = r.bureau ?? ((numero % 2 === 0) ? r.pairs : r.impairs);
      }
    }
  }

  const bureau = DATA.bureaux.find(b => b.numero === bureauNum);

  res.className = "succes";
  res.innerHTML = `âœ… <strong>Bureau ${bureau.numero} â€“ ${bureau.nom}</strong><br>ðŸ“ ${bureau.adresse}`;

  const rb = await fetch(
    "https://api-adresse.data.gouv.fr/search/?q=" +
    encodeURIComponent(bureau.adresse + ", Montivilliers") +
    "&limit=1"
  );
  const db = await rb.json();
  if (!db.features.length) return;

  const [lon, lat] = db.features[0].geometry.coordinates;

  if (!map) {
    map = L.map("map", {
      maxBounds: LIMITES_MONTIVILLIERS,
      maxBoundsViscosity: 1
    });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);
  }

  if (markerBureau) markerBureau.remove();

  markerBureau = L.marker([lat, lon], { icon: iconeUrne })
    .addTo(map)
    .bindPopup("Votre bureau de vote");

  mapDiv.style.display = "block";

  setTimeout(() => {
    map.invalidateSize();
    map.setView([lat, lon], 16);
    map.setMinZoom(map.getZoom());
  }, 100);
}
</script>

</body>
</html>
