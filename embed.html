<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Trouver son bureau de vote ‚Äì Ville de Montivilliers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --couleur-action: #e61b5c;
  --couleur-action-hover: #c91650;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #f4f6f8;
}

#bloc {
  max-width: 1000px;
  margin: 0 auto;
  padding: 1.2rem;
  background: #ffffff;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

#map {
  width: 100%;
  height: 420px;
  border-radius: 6px;
  margin-bottom: 1rem;
}

label {
  font-weight: bold;
}

input {
  width: 100%;
  padding: 0.6rem;
  margin-top: 0.4rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

button {
  width: 100%;
  margin-top: 0.8rem;
  padding: 0.7rem;
  font-size: 1rem;
  font-weight: bold;
  background: var(--couleur-action);
  color: #ffffff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background: var(--couleur-action-hover);
}

#resultat {
  margin-top: 1rem;
  padding: 0.8rem;
  border-radius: 4px;
}

#resultat.succes {
  background: #e8f3ee;
  border-left: 4px solid #2e8b57;
}

#resultat.erreur {
  background: #fbeaea;
  border-left: 4px solid #b00020;
}

.mention {
  margin-top: 1.2rem;
  font-size: 0.85rem;
  color: #555;
}

@media (max-width: 768px) {
  #map {
    height: 320px;
  }
}
</style>
</head>

<body>

<div id="bloc">

  <!-- CARTE visible d√®s l'ouverture -->
  <div id="map"></div>

  <!-- FORMULAIRE -->
  <div>
    <label for="adresse">Entrez votre adresse :</label>
    <input id="adresse" placeholder="Ex : 12 avenue Charles de Gaulle, Montivilliers">
    <button onclick="chercher()">Rechercher</button>
    <div id="resultat"></div>
  </div>

  <!-- MENTION -->
  <div class="mention">
    Les informations relatives √† votre bureau de vote figurent √©galement sur votre carte √©lectorale.
    En cas de doute, vous pouvez v√©rifier votre situation √©lectorale sur le site <a href="https://www.service-public.fr/particuliers/vosdroits/services-en-ligne-et-formulaires/ISE">Service-public.fr</a>.<br>
    <em>La carte est fournie √† titre illustratif.</em>
  </div>

</div>

<script>
/* ================== VARIABLES ================== */
let DATA, RUES = {};
let map, markerBureau;

/* ================== IC√îNE URNE ================== */
const iconeUrne = L.icon({
  iconUrl:
    "data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>\
<path d='M32 2C19 2 8 13 8 26c0 18 24 36 24 36s24-18 24-36C56 13 45 2 32 2z' fill='%23e61b5c'/>\
<rect x='20' y='24' width='24' height='16' rx='2' fill='white'/>\
<rect x='28' y='16' width='8' height='6' rx='1' fill='white'/>\
<rect x='30.5' y='12' width='3' height='10' fill='%23e61b5c'/>\
</svg>",
  iconSize: [42, 42],
  iconAnchor: [21, 42]
});

/* ================== NORMALISATION ================== */
const ALIAS = {
  pt: "president",
  pres: "president",
  f: "francois",
  st: "saint",
  ste: "sainte",
  comman: "commandant",
  cmdt: "commandant"
};

function normaliser(t) {
  let s = t.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9 ]/g, " ");

  s = s.split(" ").map(m => ALIAS[m] || m).join(" ");

  return s
    .replace(/\b(de|du|des|la|le|l|d)\b/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

/* ================== INIT CARTE ================== */
// Centre-ville ‚Äì Place Fran√ßois Mitterrand
map = L.map("map").setView([49.5464, 0.1873], 15);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

/* ================== CHARGEMENT DONN√âES ================== */
fetch("data-bureaux.json")
  .then(r => r.json())
  .then(d => {
    DATA = d;

    Object.entries(d.rues_simples).forEach(([rue, bureau]) => {
      RUES[normaliser(rue)] = { type: "simple", bureau };
    });

    Object.entries(d.rues_a_cheval).forEach(([rue, regles]) => {
      RUES[normaliser(rue)] = { type: "complexe", regles };
    });
  });

/* ================== RECHERCHE ================== */
async function chercher() {
  const res = document.getElementById("resultat");
  res.className = "";
  res.textContent = "Recherche en cours‚Ä¶";

  const saisie = document.getElementById("adresse").value;

  const r = await fetch(
    "https://api-adresse.data.gouv.fr/search/?q=" +
    encodeURIComponent(saisie) + "&limit=1"
  );
  const d = await r.json();

  if (!d.features.length) {
    res.className = "erreur";
    res.textContent = "Adresse non reconnue.";
    return;
  }

  const props = d.features[0].properties;
  const rueNorm = normaliser(props.street || "");
  const numero = parseInt(props.housenumber, 10);

  const entree = RUES[rueNorm];
  if (!entree) {
    res.className = "erreur";
    res.textContent = "Adresse √† v√©rifier aupr√®s du service √©lections.";
    return;
  }

  let bureauNum;

  if (entree.type === "simple") {
    bureauNum = entree.bureau;
  } else {
    for (const r of entree.regles.regles) {
      if (numero >= r.min && numero <= r.max) {
        bureauNum = r.bureau ?? ((numero % 2 === 0) ? r.pairs : r.impairs);
      }
    }
  }

  const bureau = DATA.bureaux.find(b => b.numero === bureauNum);

  res.className = "succes";
  res.innerHTML = `‚úÖ <strong>Bureau ${bureau.numero} ‚Äì ${bureau.nom}</strong><br>üìç ${bureau.adresse}`;

  const rb = await fetch(
    "https://api-adresse.data.gouv.fr/search/?q=" +
    encodeURIComponent(bureau.adresse + ", Montivilliers") +
    "&limit=1"
  );
  const db = await rb.json();
  if (!db.features.length) return;

  const [lon, lat] = db.features[0].geometry.coordinates;

  if (markerBureau) markerBureau.remove();

  markerBureau = L.marker([lat, lon], { icon: iconeUrne })
    .addTo(map)
    .bindTooltip(
      `Bureau ${bureau.numero} ‚Äì ${bureau.nom}`,
      {
        direction: "top",
        offset: [0, -36],
        opacity: 0.95
      }
    );

  map.setView([lat, lon], 16);
}
</script>

</body>
</html>
