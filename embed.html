<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Trouver son bureau de vote ‚Äì Ville de Montivilliers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --couleur-action: #e61b5c;
  --couleur-action-hover: #c91650;
  --couleur-fond: #f4f6f8;
  --couleur-texte: #1a1a1a;
  --couleur-succes: #2e8b57;
  --couleur-erreur: #b00020;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: var(--couleur-fond);
  color: var(--couleur-texte);
}

#bloc {
  max-width: 1000px;
  margin: 0 auto;
  padding: 1.2rem;
  background: #ffffff;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* === GRILLE RESPONSIVE PREMIUM === */
#contenu {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.2rem;
}

@media (min-width: 900px) {
  #contenu {
    grid-template-columns: 1fr 1.2fr;
    align-items: start;
  }
}

label {
  font-weight: bold;
}

input {
  width: 100%;
  padding: 0.6rem;
  margin-top: 0.4rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
}

input:focus {
  outline: none;
  border-color: var(--couleur-action);
}

button {
  width: 100%;
  margin-top: 0.8rem;
  padding: 0.7rem;
  font-size: 1rem;
  font-weight: bold;
  background: var(--couleur-action);
  color: #ffffff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background: var(--couleur-action-hover);
}

#resultat {
  margin-top: 1rem;
  padding: 0.8rem;
  border-radius: 4px;
}

#resultat.succes {
  background: #e8f3ee;
  border-left: 4px solid var(--couleur-succes);
}

#resultat.erreur {
  background: #fbeaea;
  border-left: 4px solid var(--couleur-erreur);
}

#map {
  height: 380px;
  border-radius: 6px;
  display: none;
}

.mention {
  margin-top: 1.2rem;
  font-size: 0.85rem;
  color: #555;
}
</style>
</head>

<body>

<div id="bloc">

  <div id="contenu">

    <!-- COLONNE FORMULAIRE -->
    <div>
      <label for="adresse">Entrez votre adresse :</label>
      <input id="adresse" placeholder="Ex : 12 avenue Charles de Gaule, Montivilliers">
      <button onclick="chercher()">Rechercher</button>
      <div id="resultat"></div>
    </div>

    <!-- COLONNE CARTE -->
    <div id="map"></div>

  </div>

  <div class="mention">
    Les informations relatives √† votre bureau de vote figurent √©galement sur votre carte √©lectorale.
    En cas de doute, vous pouvez v√©rifier votre situation √©lectorale sur le site
   <a href="https://www.service-public.fr/particuliers/vosdroits/services-en-ligne-et-formulaires/ISE"> <strong>Service-public.fr</strong>.</a>
    <br>
    <em>La carte est fournie √† titre illustratif.</em>
  </div>

</div>

<script>
let DATA;
let RUES = {};
let map, markerBureau;

// Limites g√©ographiques de Montivilliers
const LIMITES_MONTIVILLIERS = [
  [49.550, 0.160],
  [49.575, 0.205]
];

// Ic√¥ne URNE
const iconeUrne = L.icon({
  iconUrl: "data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24'>\
<rect x='3' y='9' width='18' height='12' rx='2' fill='%23e61b5c'/>\
<rect x='8' y='3' width='8' height='4' rx='1' fill='%231a1a1a'/>\
<rect x='10.5' y='1' width='3' height='6' fill='%23ffffff'/>\
</svg>",
  iconSize: [40, 40],
  iconAnchor: [20, 40],
  popupAnchor: [0, -36]
});

function normaliser(t) {
  return t.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/\b(de|du|des|la|le|l')\b/g, "")
    .replace(/[^a-z0-9 ]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

fetch("data-bureaux.json")
  .then(r => r.json())
  .then(d => {
    DATA = d;
    Object.entries(d.rues_simples).forEach(([rue, bureau]) => {
      RUES[normaliser(rue)] = { type: "simple", bureau };
    });
    Object.entries(d.rues_a_cheval).forEach(([rue, regles]) => {
      RUES[normaliser(rue)] = { type: "complexe", regles };
    });
  });

async function chercher() {
  const res = document.getElementById("resultat");
  const mapDiv = document.getElementById("map");
  res.className = "";
  res.textContent = "Recherche en cours‚Ä¶";
  mapDiv.style.display = "none";

  const saisie = document.getElementById("adresse").value;
  const r = await fetch("https://api-adresse.data.gouv.fr/search/?q=" + encodeURIComponent(saisie) + "&limit=1");
  const d = await r.json();

  if (!d.features.length) {
    res.className = "erreur";
    res.textContent = "Adresse non reconnue.";
    return;
  }

  const props = d.features[0].properties;
  const rueNorm = normaliser(props.street || "");
  const numero = parseInt(props.housenumber, 10);

  let entree = RUES[rueNorm];
  if (!entree) {
    res.className = "erreur";
    res.textContent = "Adresse √† v√©rifier aupr√®s du service √©lections.";
    return;
  }

  let bureauNum;

  if (entree.type === "simple") {
    bureauNum = entree.bureau;
  } else {
    for (const regle of entree.regles.regles) {
      if (numero >= regle.min && numero <= regle.max) {
        bureauNum = regle.bureau ??
          ((numero % 2 === 0) ? regle.pairs : regle.impairs);
      }
    }
  }

  const bureau = DATA.bureaux.find(b => b.numero === bureauNum);
  res.className = "succes";
  res.innerHTML = `‚úÖ <strong>Bureau ${bureau.numero} ‚Äì ${bureau.nom}</strong><br>üìç ${bureau.adresse}`;

  const rb = await fetch(
    "https://api-adresse.data.gouv.fr/search/?q=" +
    encodeURIComponent(bureau.adresse + ", Montivilliers") +
    "&limit=1"
  );
  const db = await rb.json();
  if (!db.features.length) return;

  const latB = db.features[0].geometry.coordinates[1];
  const lonB = db.features[0].geometry.coordinates[0];

  if (!map) {
    map = L.map("map", {
      maxBounds: LIMITES_MONTIVILLIERS,
      maxBoundsViscosity: 1.0
    });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);
  }

  if (markerBureau) markerBureau.remove();

  markerBureau = L.marker([latB, lonB], { icon: iconeUrne })
    .addTo(map)
    .bindPopup("Votre bureau de vote");

  map.setView([latB, lonB], 15);
  map.setMinZoom(map.getZoom());

  mapDiv.style.display = "block";
}
</script>

</body>
</html>
